# 3. Бэкенд и API

Бэкенд AIRBRO Business — это API-сервис на основе Node.js и Express.js, который служит центральным узлом для всей бизнес-логики приложения.

## Архитектура

Бэкенд построен с использованием классической сервисно-контроллерной архитектуры, что обеспечивает хорошее разделение ответственности (Separation of Concerns).

- **`routes`**: Определяют конечные точки API (endpoints) и привязывают их к соответствующим контроллерам.
- **`controllers`**: Обрабатывают входящие HTTP-запросы. Они отвечают за валидацию данных (с помощью `zod`), вызов бизнес-логики из сервисов и отправку ответа клиенту.
- **`services`**: Содержат основную бизнес-логику. Сервисы взаимодействуют с базой данных через Prisma Client и выполняют такие операции, как создание пользователя, обработка платежа или получение списка продуктов.
- **`middleware`**: Промежуточные обработчики, которые выполняются перед основными контроллерами. Они используются для аутентификации (проверка JWT), логирования, ограничения запросов (rate limiting) и т.д.
- **`utils`**: Вспомогательные функции, которые используются в разных частях приложения (например, `logger` для логирования).
- **`prisma`**: Содержит схему базы данных (`schema.prisma`) и сгенерированный Prisma Client.

## Основные маршруты API

Все маршруты API начинаются с префикса `/api`.

### Аутентификация (`/api/auth`)

- `POST /register`: Регистрация нового пользователя.
- `POST /login`: Вход пользователя, возвращает JWT-токен в `httpOnly` cookie.
- `POST /logout`: Выход пользователя, очищает cookie.
- `GET /me`: Получение данных о текущем аутентифицированном пользователе.

### Продукты (`/api/products`)

- `GET /`: Получение списка всех активных продуктов.

### Корзина (`/api/cart`)

- `GET /`: Получение содержимого корзины текущего пользователя.
- `POST /add`: Добавление продукта в корзину.
- `POST /remove`: Удаление продукта из корзины.
- `POST /update`: Изменение количества продукта в корзине.

### Платежи (`/api/payments`)

- `POST /create`: Создание нового платежа (например, для пополнения баланса или оплаты подписки).
- `GET /status/:id`: Проверка статуса конкретного платежа.

### Пользователь (`/api/user`)

- `GET /subscriptions`: Получение списка подписок текущего пользователя.
- `PUT /profile`: Обновление профиля пользователя.

## Аутентификация

Аутентификация реализована с помощью **JSON Web Tokens (JWT)**.

1.  При успешном входе (`/api/auth/login`) сервер генерирует JWT-токен.
2.  Токен сохраняется в безопасной `httpOnly` cookie, что защищает его от доступа через JavaScript на клиенте (XSS-атаки).
3.  При каждом последующем запросе к защищенным маршрутам браузер автоматически отправляет cookie с токеном.
4.  Специальный middleware на бэкенде проверяет валидность токена и, если все в порядке, извлекает из него `userId` и добавляет его в объект запроса (`req.user`).

## Обработка ошибок

Бэкенд использует централизованный обработчик ошибок.

- **Ошибки валидации (400 Bad Request):** Если данные в запросе не соответствуют схеме `zod`, контроллер возвращает ошибку 400 с подробным описанием полей, которые не прошли валидацию.
- **Ошибки аутентификации (401 Unauthorized):** Возвращаются, если пользователь пытается получить доступ к защищенному ресурсу без валидного JWT-токена.
- **Ошибки авторизации (403 Forbidden):** Возвращаются, если у пользователя нет прав на выполнение определенного действия.
- **Ошибки "Не найдено" (404 Not Found):** Возвращаются при обращении к несуществующему ресурсу.
- **Серверные ошибки (500 Internal Server Error):** Если происходит непредвиденная ошибка, она логируется, а клиенту возвращается общая ошибка 500.

---

**Далее:** [04 - Схема базы данных](./04_Database_Schema.md)
